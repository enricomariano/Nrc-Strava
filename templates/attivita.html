<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Attivit√† Strava</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script src="https://unpkg.com/@mapbox/polyline"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; overflow: hidden; }
    .layout { display: flex; height: 100%; }
    .left { width: 30%; overflow-y: auto; border-right: 1px solid #ccc; padding: 10px; background: #f0f4f8; }
    .right { width: 70%; padding: 10px; overflow-y: auto; }
    .activity-card { background: #fff; border: 1px solid #ddd; margin-bottom: 10px; padding: 10px; border-radius: 8px; transition: 0.2s ease; }
    .activity-card:hover { transform: scale(1.02); background: #e6f0ff; }
    .activity-card h3, .activity-card p { margin: 5px 0; font-size: 14px; }
    .activity-card button { float: right; padding: 5px 10px; font-size: 14px; }
    .widget { background: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 10px; margin-top: 10px; }
    #toggleAnalysis { position: fixed; bottom: 20px; right: 20px; padding: 10px 16px; font-size: 14px; background: #0078d7; color: white; border: none; border-radius: 6px; cursor: pointer; z-index: 1000; }
    #aiSummary { display: none; margin-top: 10px; }
  </style>
</head>
  <body>
<div class="layout">
  <div class="left" id="activityList"><p>Caricamento attivit√†...</p></div>
  <div class="right" id="activityDetails">
    <p>Seleziona un‚Äôattivit√† ‚Üí</p>

    <div class="widget" id="gearUsage">
      <h3>üö¥ Gear Usage</h3>
      <ul id="gearList"><li>Caricamento...</li></ul>
    </div>

    <div class="widget" id="aiSummary">
      <h3>üß† Analisi settimanale</h3>
      <p id="summaryText">Caricamento...</p>
      <canvas id="weeklyChart" style="max-height:300px;"></canvas>
    </div>
  </div>
</div>

<!-- Pulsanti fissi -->
<button id="toggleAnalysis" onclick="toggleAnalysis()"
        style="position:fixed; bottom:20px; right:20px; padding:10px 16px; font-size:14px;
               background:#0078d7; color:white; border:none; border-radius:6px; cursor:pointer;">
  Analisi settimanale
</button>

    <button onclick="fetch('/save-detailed').then(() => loadAllActivities())"
        style="position:fixed; bottom:60px; right:20px; padding:10px 16px; font-size:14px;
               background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer;">
  üîÑ Aggiorna attivit√†
</button>


<button onclick="window.open('/export/csv')"
        style="position:fixed; bottom:100px; right:20px; padding:10px 16px; font-size:14px;
               background:#ffc107; color:black; border:none; border-radius:6px; cursor:pointer;">
  üì¶ Esporta CSV
</button>

<button onclick="showStatus()"
        style="position:fixed; bottom:140px; right:20px; padding:10px 16px; font-size:14px;
               background:#17a2b8; color:white; border:none; border-radius:6px; cursor:pointer;">
  üß™ Diagnostica
</button>



<script>
function toggleAnalysis() {
  const box = document.getElementById("aiSummary");
  if (box) box.style.display = box.style.display === "none" ? "block" : "none";
}

async function loadWeeklyAnalysis() {
  try {
    const res = await fetch("/analyze/week");
    const data = await res.json();
    document.getElementById("summaryText").innerText = data.text;

    const ctx = document.getElementById("weeklyChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: data.chart.labels,
        datasets: data.chart.datasets.map(ds => ({
          ...ds,
          fill: false,
          tension: 0.2
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { font: { size: 12 } } }
        },
        scales: {
          x: { ticks: { maxTicksLimit: 10 } }
        }
      }
    });
  } catch (err) {
    console.error("Errore analisi settimanale:", err);
    document.getElementById("summaryText").innerText = "‚ö†Ô∏è Nessuna analisi disponibile";
  }
}

async function loadAllActivities() {
  try {
    const res = await fetch("/cached-activities");
    const acts = await res.json();

    const list = document.getElementById("activityList");
    list.innerHTML = "";

    if (!acts.length) {
      list.innerHTML = "<p>‚ö†Ô∏è Nessuna attivit√† trovata. Premi 'Aggiorna attivit√†' per sincronizzare.</p>";
      return;
    }

    acts.forEach(a => {
      const div = document.createElement("div");
      div.className = "activity-card";
      div.innerHTML = `<h3>${a.name}</h3><p>${a.distance_km.toFixed(1)} km</p>
                       <button onclick="showDetails(${a.id})">‚ûî</button>`;
      list.appendChild(div);
    });
  } catch (err) {
    console.error("Errore fetch attivit√†:", err);
    document.getElementById("activityList").innerHTML = "<p>‚ùå Errore nel caricamento attivit√†</p>";
  }
}

async function showDetails(id) {
  const details = document.getElementById("activityDetails");
  details.innerHTML = "<p>Caricamento dettagli...</p>";

  try {
    const res = await fetch("/cached-activities");
    const acts = await res.json();
    const act = acts.find(a => a.id === id);

    const [streamRes, detailRes] = await Promise.all([
      fetch(`/streams/${id}`),
      fetch(`/details/${id}`)
    ]);

    const streams = await streamRes.json();
    const extra = await detailRes.json();

    details.innerHTML = `
      <div class="widget">
        <h2>${act.name}</h2>
        <p>Distanza: ${act.distance_km.toFixed(1)} km</p>
        <p>Dislivello: ${extra.total_elevation_gain_m || '‚Äì'} m</p>
        <p>Tempo: ${(act.elapsed_time_sec / 60).toFixed(0)} min</p>
        <p>Velocit√† media: ${act.average_speed_kmh || '‚Äì'} km/h</p>
        <p>Potenza media: ${extra.average_watts || '‚Äì'} W</p>
        <p>Energia: ${extra.calories?.toFixed(1) || '‚Äì'} kcal</p>
        <p>HR medio: ${extra.average_heartrate || '‚Äì'} bpm</p>
        <p>Altitudine max: ${extra.elev_high_m || '‚Äì'} m ‚Äì min: ${extra.elev_low_m || '‚Äì'} m</p>
        <div style="display:flex; gap:10px;">
          <div id="map-${id}" style="width:50%; height:300px;"></div>
          <canvas id="chart-${id}" style="width:50%; max-height:300px;"></canvas>
        </div>
      </div>
    `;

    const ctx = document.getElementById(`chart-${id}`).getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: Array.from({ length: streams.velocity_smooth.length }, (_, i) => i),
        datasets: [
          { label: "Velocit√† (km/h)", data: streams.velocity_smooth, borderColor: "green", fill: false },
          { label: "Altitudine (m)", data: streams.altitude, borderColor: "blue", fill: false },
          { label: "HR (bpm)", data: streams.heartrate, borderColor: "red", fill: false },
          { label: "Watt", data: streams.watts, borderColor: "orange", fill: false }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "top" },
          title: { display: true, text: "Riepilogo attivit√†" }
        },
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { title: { display: true, text: "Tempo (s)" } },
          y: { title: { display: true, text: "Valore" } }
        }
      }
    });

    if (act.map_summary_polyline) {
      const coords = polyline.decode(act.map_summary_polyline).map(([lat, lon]) => [lon, lat]);
      const route = new ol.geom.LineString(coords).transform('EPSG:4326', 'EPSG:3857');
      const routeFeature = new ol.Feature({ geometry: route });

      const vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({ features: [routeFeature] }),
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: '#0078d7', width: 3 })
        })
      });

      new ol.Map({
        target: `map-${id}`,
        layers: [
          new ol.layer.Tile({ source: new ol.source.OSM() }),
          vectorLayer
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat(coords[0]),
          zoom: 13
        })
      });
    }
  } catch (err) {
    console.error("Errore dettagli attivit√†:", err);
    details.innerHTML = "<p>‚ùå Impossibile caricare dettagli o stream</p>";
  }
}

async function showStatus() {
  try {
    const res = await fetch("/status");
    const data = await res.json();
    alert(`üîê Token valido: ${data.token.access_token ? "‚úÖ" : "‚ùå"}\n‚è≥ Scade in: ${data.token.expires_in_sec}s\nüìÅ File attivit√†: ${data.file_status["detailed_attivita.json"] ? "‚úÖ" : "‚ùå"}\nüìä Rate limit: ${JSON.stringify(data.rate_limits)}`);
  } catch (err) {
    alert("‚ùå Errore nel recupero diagnostica");
  }
}

async function loadGearUsage() {
  try {
    const res = await fetch("/gear-usage");
    const data = await res.json();
    const list = document.getElementById("gearList");
    list.innerHTML = "";
    for (const [gear, km] of Object.entries(data)) {
      const li = document.createElement("li");
      li.innerText = `${gear}: ${km.toFixed(1)} km`;
      list.appendChild(li);
    }
  } catch (err) {
    console.error("Errore gear usage:", err);
    document.getElementById("gearList").innerHTML = "<li>‚ùå Errore nel caricamento</li>";
  }
}

window.onload = () => {
  fetch("/debug/token")
    .then(res => res.json())
    .then(data => {
      if (!data.access_token || data.expires_in_sec < 0) {
        window.location.href = `https://www.strava.com/oauth/authorize?client_id=134273&response_type=code&redirect_uri=https://nrc-strava.onrender.com/callback&approval_prompt=force&scope=activity:read_all`;
      } else {
        loadAllActivities();
        loadWeeklyAnalysis();
        loadGearUsage();
      }
    })
    .catch(err => {
      console.error("Errore controllo token:", err);
      document.getElementById("activityList").innerHTML = "<p>Errore nel controllo token</p>";
    });
};

async function loadAllActivities() {
  try {
    const res = await fetch("/cached-activities");
    const acts = await res.json();

    const list = document.getElementById("activityList");
    list.innerHTML = "";

    if (!acts.length) {
      list.innerHTML = "<p>‚ö†Ô∏è Nessuna attivit√† trovata. Premi 'Aggiorna attivit√†' per sincronizzare.</p>";
      return;
    }

    acts.forEach(a => {
      const div = document.createElement("div");
      div.className = "activity-card";
      div.innerHTML = `<h3>${a.name}</h3><p>${a.distance_km.toFixed(1)} km</p>
                       <button onclick="showDetails(${a.id})">‚ûî</button>`;
      list.appendChild(div);
    });
  } catch (err) {
    console.error("Errore fetch attivit√†:", err);
    document.getElementById("activityList").innerHTML = "<p>‚ùå Errore nel caricamento attivit√†</p>";
  }
}


async function showDetails(id) {
  const details = document.getElementById("activityDetails");
  details.innerHTML = "<p>Caricamento dettagli...</p>";

  try {
    const res = await fetch("/cached-activities");
    const acts = await res.json();
    const act = acts.find(a => a.id === id);

    const [streamRes, detailRes] = await Promise.all([
      fetch(`/streams/${id}`),
      fetch(`/details/${id}`)
    ]);

    const streams = await streamRes.json();
    const extra = await detailRes.json();

    details.innerHTML = `
      <div class="widget">
        <h2>${act.name}</h2>
        <p>Distanza: ${act.distance_km.toFixed(1)} km</p>
        <p>Dislivello: ${extra.total_elevation_gain_m || '‚Äì'} m</p>
        <p>Tempo: ${(act.elapsed_time_sec / 60).toFixed(0)} min</p>
        <p>Velocit√† media: ${act.average_speed_kmh || '‚Äì'} km/h</p>
        <p>Potenza media: ${extra.average_watts || '‚Äì'} W</p>
        <p>Energia: ${extra.calories?.toFixed(1) || '‚Äì'} kcal</p>
        <p>HR medio: ${extra.average_heartrate || '‚Äì'} bpm</p>
        <p>Altitudine max: ${extra.elev_high_m || '‚Äì'} m ‚Äì min: ${extra.elev_low_m || '‚Äì'} m</p>
        <div style="display:flex; gap:10px;">
          <div id="map-${id}" style="width:50%; height:300px;"></div>
          <canvas id="chart-${id}" style="width:50%; max-height:300px;"></canvas>
        </div>
      </div>
    `;

    const ctx = document.getElementById(`chart-${id}`).getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: Array.from({ length: streams.velocity_smooth.length }, (_, i) => i),
        datasets: [
          { label: "Velocit√† (km/h)", data: streams.velocity_smooth, borderColor: "green", fill: false },
          { label: "Altitudine (m)", data: streams.altitude, borderColor: "blue", fill: false },
          { label: "HR (bpm)", data: streams.heartrate, borderColor: "red", fill: false },
          { label: "Watt", data: streams.watts, borderColor: "orange", fill: false }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "top" },
          title: { display: true, text: "Riepilogo attivit√†" }
        },
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { title: { display: true, text: "Tempo (s)" } },
          y: { title: { display: true, text: "Valore" } }
        }
      }
    });

    if (act.map_summary_polyline) {
      const coords = polyline.decode(act.map_summary_polyline).map(([lat, lon]) => [lon, lat]);
      const route = new ol.geom.LineString(coords).transform('EPSG:4326', 'EPSG:3857');
      const routeFeature = new ol.Feature({ geometry: route });

      const vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({ features: [routeFeature] }),
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: '#0078d7', width: 3 })
        })
      });

      new ol.Map({
        target: `map-${id}`,
        layers: [
          new ol.layer.Tile({ source: new ol.source.OSM() }),
          vectorLayer
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat(coords[0]),
          zoom: 13
        })
      });
    }
  } catch (err) {
    console.error("Errore dettagli attivit√†:", err);
    details.innerHTML = "<p>‚ùå Impossibile caricare dettagli o stream</p>";
  }
}


    if (act.map_summary_polyline) {
      const coords = polyline.decode(act.map_summary_polyline).map(([lat, lon]) => [lon, lat]);
      const route = new ol.geom.LineString(coords).transform('EPSG:4326', 'EPSG:3857');
      const routeFeature = new ol.Feature({ geometry: route });

      const vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({ features: [routeFeature] }),
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: '#0078d7', width: 3 })
        })
      });

      new ol.Map({
        target: `map-${id}`,
        layers: [
          new ol.layer.Tile({ source: new ol.source.OSM() }),
          vectorLayer
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat(coords[0]),
          zoom: 13
        })
      });
    }
  } catch (err) {
    console.error("Errore dettagli attivit√†:", err);
    details.innerHTML = "<p>‚ùå Impossibile caricare dettagli o stream</p>";
  }
}
</script>
</body>
</html>
